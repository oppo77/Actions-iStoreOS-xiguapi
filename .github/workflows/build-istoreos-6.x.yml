name: Build iStore OS 6.x (Xiguapi V3)

on:
  repository_dispatch:
  workflow_dispatch:
  schedule:
    - cron: 0 16 * * *

env:
  REPO_URL: https://github.com/istoreos/istoreos
  REPO_BRANCH: istoreos-24.10.2
  FEEDS_CONF: feeds.conf
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1-6.x.sh
  DIY_P2_SH: diy-part2-6.x.sh
  UPLOAD_BIN_DIR: true
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  ARCHITECTURE: armv8

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
    - name: æœ€å¤§åŒ–ç£ç›˜ç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        swap-size-mb: 2048
        temp-reserve-mb: 50
        root-reserve-mb: 2048
        remove-dotnet: true
        remove-android: true
        remove-haskell: true
        remove-codeql: true

    - name: å‡†å¤‡å®Œæˆ
      uses: actions/checkout@main

    - name: åˆ›å»ºå·¥ä½œç›®å½•å’Œç¼“å­˜
      run: |
        mkdir -p ${GITHUB_WORKSPACE}/workdir
        mkdir -p ${GITHUB_WORKSPACE}/ccache
        chmod 755 ${GITHUB_WORKSPACE}/workdir ${GITHUB_WORKSPACE}/ccache
        echo "WORKDIR=${GITHUB_WORKSPACE}/workdir" >> $GITHUB_ENV
        echo "CCACHE_DIR=${GITHUB_WORKSPACE}/ccache" >> $GITHUB_ENV
        echo "OPENWRT_ROOT=${GITHUB_WORKSPACE}/workdir/openwrt" >> $GITHUB_ENV

    - name: ç¼“å­˜CCACHE
      uses: actions/cache@v4
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ${{ runner.os }}-ccache-${{ env.ARCHITECTURE }}-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-ccache-${{ env.ARCHITECTURE }}-

    - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ (GCCç‰ˆæœ¬)
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        echo "æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨..."
        sudo apt update -y
        
        echo "å®‰è£…ç¼–è¯‘æ ¸å¿ƒä¾èµ–ï¼ˆGCCå·¥å…·é“¾ï¼‰..."
        sudo apt install -y \
          build-essential \
          flex bison g++ gawk gcc-multilib g++-multilib \
          autoconf automake binutils libtool patch pkgconf quilt \
          gettext libncursesw5-dev libncurses-dev libreadline-dev \
          libssl-dev libelf-dev libglib2.0-dev device-tree-compiler \
          liblzma-dev libc6-dev-i386 lib32gcc-s1 lib32stdc++6 zlib1g-dev \
          python3 python3-pyelftools python3-setuptools python3-distutils \
          python3-pip python3-yaml python3-dev libpython3-dev \
          bzip2 ccache cpio curl rsync squashfs-tools unzip xxd bc haveged \
          uuid-runtime dosfstools mtools parted u-boot-tools \
          git xsltproc libxml-parser-perl ant wget cmake ninja-build patchelf swig \
          openjdk-11-jre-headless
        
        echo "å®‰è£…Pythonå·¥å…·..."
        sudo pip3 install pyelftools setuptools pyyaml --no-cache-dir
        
        echo "é…ç½®CCACHE..."
        ccache --set-config=max_size=10G
        ccache --set-config=compression=true
        ccache --set-config=compression_level=6
        ccache -s
        
        echo "è®¾ç½®æ—¶åŒº..."
        sudo timedatectl set-timezone "$TZ"
        
        echo "âœ… GCCç¼–è¯‘ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

    - name: å…‹éš†æºç 
      working-directory: ${{ env.WORKDIR }}
      run: |
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        git clone --depth 1 ${{ env.REPO_URL }} -b ${{ env.REPO_BRANCH }} openwrt
        echo "æºç å…‹éš†å®Œæˆ"
        ln -sf ${{ env.WORKDIR }}/openwrt $GITHUB_WORKSPACE/openwrt || true

    - name: æ‰§è¡Œxiguapi-v3è®¾å¤‡é€‚é…è„šæœ¬ï¼ˆç¡¬ä»¶é€‚é…ï¼‰
      run: |
        echo "ğŸ”„ æ‰§è¡ŒXiguapi V3è®¾å¤‡ç¡¬ä»¶é€‚é…..."
        SCRIPT_PATH="${GITHUB_WORKSPACE}/xiguapi/xiguapi-v3-adapt.sh"
        if [ -f "$SCRIPT_PATH" ]; then
          chmod +x "$SCRIPT_PATH"
          echo "OPENWRT_ROOTè®¾ç½®ä¸º: $OPENWRT_ROOT"
          cd "${GITHUB_WORKSPACE}"
          $SCRIPT_PATH
          if [ $? -eq 0 ]; then
            echo "âœ… Xiguapi V3è®¾å¤‡ç¡¬ä»¶é€‚é…æˆåŠŸ"
          else
            echo "âŒ Xiguapi V3è®¾å¤‡ç¡¬ä»¶é€‚é…å¤±è´¥"
            exit 1
          fi
        else
          echo "âŒ é€‚é…è„šæœ¬ä¸å­˜åœ¨: $SCRIPT_PATH"
          exit 1
        fi

    - name: åŠ è½½è‡ªå®šä¹‰ feeds
      env:
        FEEDS_CONF_PATH: ${{ github.workspace }}/${{ env.ARCHITECTURE }}/${{ env.FEEDS_CONF }}
      working-directory: ${{ env.OPENWRT_ROOT }}
      run: |
        echo "ğŸ“¦ åŠ è½½è‡ªå®šä¹‰feeds..."
        if [ -e "$FEEDS_CONF_PATH" ]; then
          cp "$FEEDS_CONF_PATH" ${{ env.FEEDS_CONF }}
          echo "âœ… å·²åŠ è½½è‡ªå®šä¹‰ feeds.conf"
        fi
        
        sed -i '/luci-app-baidupcs-web/d' ${{ env.FEEDS_CONF }}
        sed -i '/baidupcs-web/d' ${{ env.FEEDS_CONF }}
        echo "âœ… å·²æ’é™¤luci-app-baidupcs-webç›¸å…³åŒ…"

    - name: æ›´æ–° feedsï¼ˆç¬¬1éï¼‰
      working-directory: ${{ env.OPENWRT_ROOT }}
      run: ./scripts/feeds update -a

    - name: æ›´æ–° feedsï¼ˆç¬¬2éï¼‰
      working-directory: ${{ env.OPENWRT_ROOT }}
      run: ./scripts/feeds update -a

    - name: å®‰è£… feedsï¼ˆç¬¬1éï¼‰- æ’é™¤ luci-app-baidupcs-web
      working-directory: ${{ env.OPENWRT_ROOT }}
      run: ./scripts/feeds install -a -x luci-app-baidupcs-web

    - name: å®‰è£… feedsï¼ˆç¬¬2éï¼‰- æ’é™¤ luci-app-baidupcs-web
      working-directory: ${{ env.OPENWRT_ROOT }}
      run: |
        ./scripts/feeds install -a -x luci-app-baidupcs-web
        rm -rf package/feeds/*/luci-app-baidupcs-web 2>/dev/null || true
        rm -rf package/feeds/*/baidupcs-web 2>/dev/null || true
        rm -rf package/custom/luci-app-baidupcs-web 2>/dev/null || true
        rm -rf package/custom/baidupcs-web 2>/dev/null || true
        echo "âœ… feedså®‰è£…å®Œæˆ"

    - name: æ‰§è¡Œdiy-part2-6.x.shï¼ˆæ·»åŠ é¢å¤–åŒ…ï¼‰
      working-directory: ${{ env.OPENWRT_ROOT }}
      run: |
        echo "ğŸ”„ æ‰§è¡Œdiy-part2.shæ·»åŠ é¢å¤–åŒ…..."
        chmod +x ${{ github.workspace }}/${{ env.DIY_P2_SH }}
        ${{ github.workspace }}/${{ env.DIY_P2_SH }}
        echo "âœ… diy-part2.shæ‰§è¡Œå®Œæˆ"

    - name: åŠ è½½è‡ªå®šä¹‰é…ç½®
      env:
        CONFIG_FILE_PATH: ${{ github.workspace }}/${{ env.ARCHITECTURE }}/${{ env.CONFIG_FILE }}
      working-directory: ${{ env.OPENWRT_ROOT }}
      run: |
        echo "ğŸ“„ åŠ è½½è‡ªå®šä¹‰é…ç½®..."
        
        if [ ! -f "$CONFIG_FILE_PATH" ]; then
          echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_FILE_PATH"
          exit 1
        fi
        
        cp "$CONFIG_FILE_PATH" "${{ env.CONFIG_FILE }}"
        echo "âœ… å·²å¤åˆ¶è‡ªå®šä¹‰é…ç½®æ–‡ä»¶"
        
        echo "ğŸ” éªŒè¯å…³é”®é…ç½®é¡¹..."
        
        REQUIRED_CONFIGS=(
          "CONFIG_TARGET_rockchip_armv8=y"
          "CONFIG_TARGET_rockchip_armv8_DEVICE_nlnet_xiguapi-v3=y"
        )
        
        missing_configs=()
        for config in "${REQUIRED_CONFIGS[@]}"; do
          clean_config=$(echo "$config" | sed 's/"//g')
          if grep -q "$clean_config" .config; then
            echo "  âœ… $config"
          else
            echo "  âŒ $config"
            missing_configs+=("$config")
          fi
        done
        
        if [ ${#missing_configs[@]} -gt 0 ]; then
          echo "âŒ é…ç½®æ–‡ä»¶ç¼ºå¤±å¿…éœ€é¡¹"
          exit 1
        fi
        
        echo "âš™ï¸ è¿è¡Œ make defconfig..."
        make defconfig >/dev/null 2>&1
        
        if ! grep -q "CONFIG_CCACHE=y" .config; then
          echo "CONFIG_CCACHE=y" >> .config
        fi
        
        echo "âœ… é…ç½®åŠ è½½å®Œæˆ"

    - name: æ‰§è¡Œdiy-part1-6.x.shï¼ˆç‰ˆæœ¬ä¿¡æ¯ä¿®æ”¹ï¼‰
      working-directory: ${{ env.OPENWRT_ROOT }}
      run: |
        echo "ğŸ”„ æ‰§è¡Œdiy-part1.shä¿®æ”¹ç‰ˆæœ¬ä¿¡æ¯..."
        chmod +x ${{ github.workspace }}/${{ env.DIY_P1_SH }}
        ${{ github.workspace }}/${{ env.DIY_P1_SH }}
        echo "âœ… diy-part1.shæ‰§è¡Œå®Œæˆ"

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      working-directory: ${{ env.OPENWRT_ROOT }}
      run: |
        make defconfig
        make download -j8

    - name: ç¼–è¯‘å›ºä»¶
      id: compile
      working-directory: ${{ env.OPENWRT_ROOT }}
      run: |
        echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘å›ºä»¶..."
        export CCACHE_DIR=${{ env.CCACHE_DIR }}
        export USE_CCACHE=1
        
        make -j$(nproc) || make -j1 V=s
        
        if [ -d "bin/targets" ]; then
          echo "âœ… ç¼–è¯‘æˆåŠŸ"
          echo "status=success" >> ${GITHUB_OUTPUT}
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          exit 1
        fi
        
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
      if: (!cancelled())
      run: df -hT

    - name: ä¸Šä¼  bin æ–‡ä»¶å¤¹
      uses: actions/upload-artifact@v4
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      with:
        name: OpenWrt_bin${{ env.FILE_DATE }}
        path: ${{ env.OPENWRT_ROOT }}/bin

    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      working-directory: ${{ env.OPENWRT_ROOT }}
      run: |
        cd bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> ${GITHUB_OUTPUT}

    - name: ä¸Šä¼ å›ºä»¶ç›®å½•
      uses: actions/upload-artifact@v4
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: Xiguapi-V3_Firmware${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}/*

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "release_tag=v$(date +"%Y.%m.%d-%H.%M")-xiguapi-v3" >> ${GITHUB_OUTPUT}
        touch release.txt
        echo "
        ğŸš€ iStore OS 6.x for Xiguapi V3
        -----------------------------------------
        ğŸ’» è®¾å¤‡å‹å·: Xiguapi V3
        ğŸ—ï¸ æ¶æ„: ${{ env.ARCHITECTURE }}
        ğŸ“‚ æºç : ${{ env.REPO_URL }}
        ğŸŒ³ åˆ†æ”¯: ${{ env.REPO_BRANCH }}
        â±ï¸ ç¼–è¯‘æ—¶é—´: $(date +"%Yå¹´%mæœˆ%dæ—¥%Hæ—¶%Måˆ†")
        ğŸ”§ å†…æ ¸ç‰ˆæœ¬: 6.x
        -----------------------------------------
        ğŸŒ é»˜è®¤ç®¡ç†åœ°å€: 192.168.100.1
        ğŸ‘¤ ç”¨æˆ·å: root
        ğŸ”’ å¯†ç : password
        -----------------------------------------
        ğŸ“’ è¯´æ˜:
        1. å•ç½‘å£è®¾å¤‡é»˜è®¤ç½‘å£ä¸ºLANï¼Œæ—è·¯ç”±æ¨¡å¼
        2. éœ€è¦æ¥å…¥ä¸»è·¯ç”±å™¨åè¿›åå°æŸ¥æ‰¾å¯¹åº”IPåœ°å€è®¿é—®
        3. åŒç½‘å£è®¾å¤‡é»˜è®¤ç½‘å£ä¸ºWAN+LANï¼Œä¸»è·¯ç”±æ¨¡å¼
        4. Xiguapi V3ä¸“å±é€‚é…å›ºä»¶
        -----------------------------------------
        ğŸ”— é¡¹ç›®åœ°å€: https://github.com/${{ github.repository }}
        " >> release.txt
        echo "status=success" >> ${GITHUB_OUTPUT}

    - name: è‡ªåŠ¨å‘å¸ƒå›ºä»¶åˆ° Releases
      uses: softprops/action-gh-release@v2
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*
        prerelease: false
        draft: false

    - name: æ¸…ç†æ—§å·¥ä½œæµè¿è¡Œè®°å½•ï¼ˆè‡ªä¸»æ§åˆ¶ï¼‰
      if: always()
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "å¼€å§‹æ¸…ç†æœ¬å·¥ä½œæµçš„æ—§è¿è¡Œè®°å½•..."
        # è®¾ç½®ä½ æƒ³ä¿ç•™çš„æœ€æ–°è®°å½•æ¡æ•°ï¼Œå»ºè®®15-20
        total_to_keep=15
        
        runs=$(gh run list --workflow="${{ github.workflow }}" --json databaseId,status,createdAt --jq '.[] | select(.status != "in_progress" and .status != "queued") | "\(.databaseId) \(.createdAt)"' | sort -k2)
        
        total_runs=$(echo "$runs" | wc -l)
        
        if [ $total_runs -le $total_to_keep ]; then
          echo "å½“å‰åªæœ‰ ${total_runs} æ¡è®°å½•ï¼Œæœªè¶…è¿‡ä¿ç•™ä¸Šé™ ${total_to_keep}ï¼Œè·³è¿‡æ¸…ç†ã€‚"
          exit 0
        fi
        
        runs_to_delete=$((total_runs - total_to_keep))
        echo "æ‰¾åˆ° ${total_runs} æ¡è®°å½•ï¼Œè®¡åˆ’åˆ é™¤æœ€æ—§çš„ ${runs_to_delete} æ¡ã€‚"
        
        delete_ids=$(echo "$runs" | head -n $runs_to_delete | awk '{print $1}')
        
        for run_id in $delete_ids; do
          echo "æ­£åœ¨åˆ é™¤è¿è¡Œè®°å½• ID: $run_id"
          gh run delete "$run_id" --confirm || echo "åˆ é™¤ $run_id å¤±è´¥ï¼ˆå¯èƒ½å·²è¢«å…¶ä»–è¿›ç¨‹åˆ é™¤ï¼‰"
        done
        echo "âœ… å·¥ä½œæµè¿è¡Œè®°å½•æ¸…ç†å®Œæˆã€‚"

    - name: åˆ é™¤è‡ªåŠ¨å‘å¸ƒçš„æ—§å›ºä»¶
      uses: dev-drprasad/delete-older-releases@v0.3.3
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 20
        delete_tag_pattern: "v.*-xiguapi-v3"
        delete_tags: true
