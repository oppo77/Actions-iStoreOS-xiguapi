name: Build iStore OS 6.x (Xiguapi V3)

on:
  repository_dispatch:
  workflow_dispatch:
  schedule:
    - cron: 0 16 * * *

env:
  REPO_URL: https://github.com/istoreos/istoreos
  REPO_BRANCH: istoreos-24.10.2
  FEEDS_CONF: feeds.conf
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1-6.x.sh
  DIY_P2_SH: diy-part2-6.x.sh
  UPLOAD_BIN_DIR: true
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  ARCHITECTURE: armv8

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write  # ç¡®ä¿å‘å¸ƒReleasesæƒé™

    steps:
    - name: æœ€å¤§åŒ–ç£ç›˜ç©ºé—´ï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼‰
      uses: easimon/maximize-build-space@master
      with:
        swap-size-mb: 2048
        temp-reserve-mb: 50
        root-reserve-mb: 2048
        remove-dotnet: true
        remove-android: true
        remove-haskell: true
        remove-codeql: true

    - name: å‡†å¤‡å®Œæˆ
      uses: actions/checkout@main

    - name: åˆ›å»ºå·¥ä½œç›®å½•
      run: |
        mkdir -p ${GITHUB_WORKSPACE}/workdir
        mkdir -p ${GITHUB_WORKSPACE}/ccache  # æ–°å¢ï¼šåˆ›å»ºccacheç¼“å­˜ç›®å½•
        chmod 755 ${GITHUB_WORKSPACE}/workdir ${GITHUB_WORKSPACE}/ccache
        echo "WORKDIR=${GITHUB_WORKSPACE}/workdir" >> $GITHUB_ENV
        echo "CCACHE_DIR=${GITHUB_WORKSPACE}/ccache" >> $GITHUB_ENV  # æ–°å¢ï¼šé…ç½®ccacheè·¯å¾„
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"

    - name: ç¼“å­˜CCACHEï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼šåŠ é€Ÿé‡å¤ç¼–è¯‘ï¼‰
      uses: actions/cache@v4  # æ–°å¢ï¼šå¯ç”¨ccacheç¼“å­˜
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ${{ runner.os }}-ccache-${{ env.ARCHITECTURE }}-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-ccache-${{ env.ARCHITECTURE }}-

    - name: æ£€æŸ¥æœåŠ¡å™¨é…ç½®
      run: |
        echo "è‹¥åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½ä¸è¶³ï¼ŒåŠ¡å¿…åŠæ—¶å–æ¶ˆï¼Œé‡æ–°è¿è¡Œï¼"
        echo -e "------------------------------- CPUä¿¡æ¯ -------------------------------\n"
        echo "CPUç‰©ç†æ•°é‡:$(cat /proc/cpuinfo| grep "physical id"| sort| uniq| wc -l)"
        echo -e "CPUæ ¸å¿ƒåŠç‰ˆæœ¬ä¿¡æ¯: $(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c) \n"
        echo -e "------------------------------- å†…å­˜ä¿¡æ¯ -------------------------------\n"
        echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯: "
        sudo lshw -short -C memory | grep GiB
        echo -e "\n"
        echo -e "------------------------------- ç£ç›˜ä¿¡æ¯ï¼ˆæ¸…ç†å‰ï¼‰ -------------------------------\n"
        df -Th

    - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼šè¡¥å……LLVM/Clangå®Œæ•´ä¾èµ–ï¼‰
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        echo "------------------------------- ä»…æ›´æ–°æºï¼ˆè·³è¿‡upgradeï¼Œé¿å…å ç”¨ç©ºé—´ï¼‰ -------------------------------"
        sudo apt update -y

        echo "------------------------------- å®‰è£…ç¼–è¯‘æ ¸å¿ƒä¾èµ–ï¼ˆè¡¥å……LLVM/Clangå®Œæ•´å¥—ä»¶ï¼‰ -------------------------------"
        sudo apt install -y \
          build-essential clang lld libllvm-dev llvm-bpf llvm \  # æ–°å¢ï¼šlld libllvm-dev llvm-bpf llvm
          flex bison g++ gawk gcc-multilib g++-multilib \
          autoconf automake binutils libtool patch pkgconf quilt \
          gettext libncursesw5-dev libncurses-dev libreadline-dev \
          libssl-dev libelf-dev libglib2.0-dev device-tree-compiler \
          liblzma-dev libc6-dev-i386 lib32gcc-s1 lib32stdc++6 zlib1g-dev \
          python3 python3-pyelftools python3-setuptools python3-distutils \
          python3-pip python3-yaml python3-dev libpython3-dev \
          bzip2 ccache cpio curl rsync squashfs-tools unzip xxd bc haveged \
          uuid-runtime dosfstools mtools parted u-boot-tools \
          git xsltproc libxml-parser-perl ant wget cmake ninja-build patchelf swig \
          openjdk-11-jre-headless
        
        echo "------------------------------- éªŒè¯LLVM/Clangå®‰è£… -------------------------------"  # æ–°å¢ï¼šéªŒè¯ä¾èµ–å®‰è£…
        clang --version
        llvm-config --version
        lld --version
        echo "------------------------------- Pythonå·¥å…·å®‰è£… -------------------------------"
        sudo pip3 install pyelftools setuptools pyyaml --no-cache-dir
        
        echo "------------------------------- é…ç½®CCACHEï¼ˆå¯ç”¨å‹ç¼©+å¢å¤§ç¼“å­˜ï¼‰ -------------------------------"  # æ–°å¢ï¼šä¼˜åŒ–ccacheé…ç½®
        ccache --set-config=max_size=10G
        ccache --set-config=compression=true
        ccache --set-config=compression_level=6
        ccache -s  # æŸ¥çœ‹ccacheåˆå§‹çŠ¶æ€
        
        echo "------------------------------- æœ€ç»ˆç£ç›˜æ£€æŸ¥ -------------------------------"
        df -Th
        
        echo "------------------------------- è®¾ç½®æ—¶åŒº -------------------------------"
        sudo timedatectl set-timezone "$TZ"

    - name: å…‹éš†æºç 
      working-directory: ${{ env.WORKDIR }}
      run: |
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        df -hT $PWD
        git clone --depth 1 ${{ env.REPO_URL }} -b ${{ env.REPO_BRANCH }} openwrt
        echo "æºç å…‹éš†å®Œæˆï¼Œå½“å‰ç›®å½•å†…å®¹:"
        ls -la
        ln -sf ${{ env.WORKDIR }}/openwrt $GITHUB_WORKSPACE/openwrt || true

    - name: æ‰§è¡Œxiguapi-v3è®¾å¤‡é€‚é…è„šæœ¬
      run: |
        echo "å·¥ä½œç›®å½•: ${{ env.WORKDIR }}"
        SCRIPT_PATH="${GITHUB_WORKSPACE}/xiguapi/xiguapi-v3-adapt.sh"
        if [ -f "$SCRIPT_PATH" ]; then
          echo "æ‰¾åˆ°é€‚é…è„šæœ¬: $SCRIPT_PATH"
          chmod +x $SCRIPT_PATH
          export OPENWRT_ROOT="${{ env.WORKDIR }}/openwrt"
          echo "OPENWRT_ROOTè®¾ç½®ä¸º: $OPENWRT_ROOT"
          $SCRIPT_PATH
          if [ $? -eq 0 ]; then
            echo "âœ… xiguapi-v3é€‚é…è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
          else
            echo "âŒ xiguapi-v3é€‚é…è„šæœ¬æ‰§è¡Œå¤±è´¥"
            exit 1
          fi
        else
          echo "âŒ é€‚é…è„šæœ¬ä¸å­˜åœ¨: $SCRIPT_PATH"
          find ${GITHUB_WORKSPACE} -name "*.sh" -type f | head -20
          exit 1
        fi

    - name: åŠ è½½è‡ªå®šä¹‰ feeds + æ’é™¤ luci-app-baidupcs-web
      env:
        FEEDS_CONF_PATH: ${{ env.ARCHITECTURE }}/${{ env.FEEDS_CONF }}
      working-directory: ${{ env.WORKDIR }}/openwrt
      run: |
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        # åŠ è½½è‡ªå®šä¹‰feeds.conf
        [ -e $FEEDS_CONF_PATH ] && mv $FEEDS_CONF_PATH ${{ env.FEEDS_CONF }}
        # æ‰§è¡Œdiy-part1.shï¼ˆåœ¨æ­¤è„šæœ¬ä¸­æ·»åŠ è¿‡æ»¤é€»è¾‘ï¼‰
        chmod +x ${{ github.workspace }}/${{ env.DIY_P1_SH }}
        ${{ github.workspace }}/${{ env.DIY_P1_SH }}
        # é¢å¤–è¿‡æ»¤ï¼šåˆ é™¤feedsä¸­åŒ…å«luci-app-baidupcs-webçš„è¡Œï¼ˆé˜²æ­¢é—æ¼ï¼‰
        sed -i '/luci-app-baidupcs-web/d' ${{ env.FEEDS_CONF }}
        sed -i '/baidupcs-web/d' ${{ env.FEEDS_CONF }}
        echo "âœ… å·²åœ¨feedsé…ç½®ä¸­æ’é™¤luci-app-baidupcs-webç›¸å…³åŒ…"
        cat ${{ env.FEEDS_CONF }} | grep -vE "baidupcs|BAIDUPCS"  # éªŒè¯è¿‡æ»¤ç»“æœ

    - name: æ›´æ–° feedsï¼ˆç¬¬1éï¼‰
      working-directory: ${{ env.WORKDIR }}/openwrt
      run: ./scripts/feeds update -a

    - name: æ›´æ–° feedsï¼ˆç¬¬2éï¼‰
      working-directory: ${{ env.WORKDIR }}/openwrt
      run: ./scripts/feeds update -a

    - name: å®‰è£… feedsï¼ˆç¬¬1éï¼‰- æ’é™¤ luci-app-baidupcs-web
      working-directory: ${{ env.WORKDIR }}/openwrt
      run: ./scripts/feeds install -a -x luci-app-baidupcs-web

    - name: å®‰è£… feedsï¼ˆç¬¬2éï¼‰- æ’é™¤ luci-app-baidupcs-web + æ¸…ç†æ®‹ç•™ä¾èµ–
      working-directory: ${{ env.WORKDIR }}/openwrt
      run: |
        ./scripts/feeds install -a -x luci-app-baidupcs-web
        # æ¸…ç†å¯èƒ½æ®‹ç•™çš„baidupcs-webç›¸å…³ç›®å½•
        rm -rf package/feeds/*/luci-app-baidupcs-web
        rm -rf package/feeds/*/baidupcs-web
        rm -rf package/custom/luci-app-baidupcs-web
        rm -rf package/custom/baidupcs-web
        echo "âœ… ä¸¤éfeedså®‰è£…å®Œæˆï¼Œå·²æ¸…ç†baidupcsç›¸å…³æ®‹ç•™ä¾èµ–"

    - name: åŠ è½½è‡ªå®šä¹‰é…ç½® + éªŒè¯CCACHE/LLVMé…ç½®
      env:
        CONFIG_FILE_PATH: ${{ github.workspace }}/${{ env.ARCHITECTURE }}/${{ env.CONFIG_FILE }}
      working-directory: ${{ env.WORKDIR }}/openwrt
      run: |
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        [ -d "files" ] && mv files ${{ github.workspace }}/files && echo "âœ… å¤‡ä»½ files ç›®å½•å®Œæˆ"
        
        if [ -e "$CONFIG_FILE_PATH" ]; then
          cp "$CONFIG_FILE_PATH" "${{ env.CONFIG_FILE }}"
          echo "âœ… åŠ è½½è‡ªå®šä¹‰é…ç½®æ–‡ä»¶: $CONFIG_FILE_PATH"
        else
          echo "âŒ è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_FILE_PATH"
          echo "å½“å‰ä»“åº“æ ¹ç›®å½•ä¸‹çš„ armv8 ç›®å½•å†…å®¹: $(ls -la ${{ github.workspace }}/${{ env.ARCHITECTURE }}/ 2>/dev/null || true)"
          exit 1
        fi
        
        # æ‰§è¡Œdiy-part2.sh
        chmod +x ${{ github.workspace }}/${{ env.DIY_P2_SH }}
        ${{ github.workspace }}/${{ env.DIY_P2_SH }}
        echo "âœ… æ‰§è¡Œ diy-part2.sh å®Œæˆ"
        
        # æœ€ç»ˆæ¸…ç†ï¼šç¡®ä¿.configä¸­æ— baidupcsç›¸å…³é…ç½®
        sed -i '/luci-app-baidupcs-web/d' .config
        sed -i '/baidupcs-web/d' .config
        sed -i '/CONFIG_PACKAGE_luci-app-baidupcs-web/d' .config
        sed -i '/CONFIG_PACKAGE_baidupcs-web/d' .config
        echo "âœ… å½»åº•ç§»é™¤baidupcsç›¸å…³é…ç½®"
        
        # æ–°å¢ï¼šéªŒè¯CCACHEå’ŒLLVMé…ç½®æ˜¯å¦å¯ç”¨
        echo "===== éªŒè¯CCACHE/LLVMé…ç½® ====="
        if ! grep -q "CONFIG_CCACHE=y" .config; then
          echo "âŒ é”™è¯¯ï¼š.config ä¸­æœªå¯ç”¨ CCACHEï¼Œè‡ªåŠ¨æ·»åŠ "
          echo "CONFIG_CCACHE=y" >> .config
        else
          echo "âœ… CCACHE å·²å¯ç”¨"
        fi
        
        if ! grep -q "CONFIG_USE_LLVM_BUILD=y" .config; then
          echo "âš ï¸ æç¤ºï¼š.config ä¸­æœªå¯ç”¨ LLVM ç¼–è¯‘é“¾ï¼Œè‹¥éœ€è¦è¯·æ‰‹åŠ¨å¼€å¯"
        else
          echo "âœ… LLVM ç¼–è¯‘é“¾å·²å¯ç”¨"
        fi
        
        # éªŒè¯ç¼–è¯‘ç›®æ ‡é…ç½®
        echo "===== éªŒè¯ç¼–è¯‘ç›®æ ‡é…ç½® ====="
        if ! grep -q "CONFIG_TARGET_rockchip_armv8=y" .config; then
          echo "âŒ é”™è¯¯ï¼š.config ä¸­æœªé€‰ä¸­ rockchip/armv8 ç›®æ ‡"
          grep -E "CONFIG_TARGET_(rockchip|ath79|ramips)" .config || true
          exit 1
        fi
        
        if ! grep -q "CONFIG_TARGET_rockchip_armv8_DEVICE_nlnet_xiguapi-v3=y" .config; then
          echo "âŒ é”™è¯¯ï¼š.config ä¸­æœªé€‰ä¸­ nlnet_xiguapi-v3 è®¾å¤‡"
          grep -E "CONFIG_TARGET_rockchip_armv8_DEVICE_" .config || true
          exit 1
        fi
        
        if grep -q "CONFIG_TARGET_ath79=y" .config; then
          echo "âŒ é”™è¯¯ï¼š.config ä¸­ä»é€‰ä¸­äº† ath79 ç›®æ ‡ï¼Œéœ€ç¦ç”¨"
          sed -i '/CONFIG_TARGET_ath79=y/d' .config
          sed -i 's/CONFIG_TARGET_ath79=.*/# CONFIG_TARGET_ath79 is not set/' .config
          echo "âœ… å·²ç¦ç”¨ ath79 ç›®æ ‡"
        fi
        
        echo "===== ç¼–è¯‘ç›®æ ‡é…ç½®éªŒè¯é€šè¿‡ ====="

    - name: ä¸‹è½½è½¯ä»¶åŒ…ï¼ˆç¬¬1éï¼‰
      working-directory: ${{ env.WORKDIR }}/openwrt
      run: |
        make defconfig
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: ä¸‹è½½è½¯ä»¶åŒ…ï¼ˆç¬¬2éï¼‰
      working-directory: ${{ env.WORKDIR }}/openwrt
      run: |
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: ç¼–è¯‘å›ºä»¶ï¼ˆä¼˜åŒ–ï¼šå¯ç”¨CCACHE+LLVMï¼Œå¤±è´¥æ—¶å•çº¿ç¨‹è°ƒè¯•ï¼‰
      id: compile
      working-directory: ${{ env.WORKDIR }}/openwrt
      run: |
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        echo "CCACHE çŠ¶æ€ï¼ˆç¼–è¯‘å‰ï¼‰:"
        ccache -s  # æ–°å¢ï¼šæŸ¥çœ‹ccacheçŠ¶æ€
        echo -e "$(nproc) thread compile (CCACHE+LLVM)"
        # å¯ç”¨CCACHEå’ŒLLVMç¼–è¯‘é“¾ï¼Œé¦–æ¬¡å¤šçº¿ç¨‹ç¼–è¯‘ï¼Œå¤±è´¥åˆ™å•çº¿ç¨‹å¸¦æ—¥å¿—è°ƒè¯•
        export CCACHE_DIR=${{ env.CCACHE_DIR }}
        export USE_CCACHE=1
        make -j$(nproc) || make -j1 V=s
        # æŸ¥çœ‹CCACHEä½¿ç”¨æƒ…å†µ
        ccache -s  # æ–°å¢ï¼šæŸ¥çœ‹ccacheç¼–è¯‘åçŠ¶æ€
        # æ£€æŸ¥ç¼–è¯‘ç»“æœ
        if [ -d "bin/targets" ]; then
          echo "âœ… ç¼–è¯‘æˆåŠŸï¼Œå¼€å§‹æ•´ç†å›ºä»¶"
          echo "status=success" >> ${GITHUB_OUTPUT}
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œæ— ç›®æ ‡è¾“å‡ºç›®å½•"
          exit 1
        fi
        # è®°å½•ç¼–è¯‘æ—¶é—´
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
      if: (!cancelled())
      run: df -hT

    - name: ä¸Šä¼  bin æ–‡ä»¶å¤¹
      uses: actions/upload-artifact@main
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      with:
        name: OpenWrt_bin${{ env.FILE_DATE }}
        path: ${{ env.WORKDIR }}/openwrt/bin
        retention-days: 7  # ä¿ç•™7å¤©ï¼ŒèŠ‚çœç©ºé—´

    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      working-directory: ${{ env.WORKDIR }}/openwrt
      run: |
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        # å®šä½å›ºä»¶ç›®å½•
        if [ -d "bin/targets/rockchip/armv8" ]; then
          FIRMWARE_DIR="bin/targets/rockchip/armv8"
        else
          TARGET_DIRS=($(find bin/targets -maxdepth 2 -mindepth 2 -type d ! -name "packages" 2>/dev/null))
          if [ ${#TARGET_DIRS[@]} -gt 0 ]; then
            FIRMWARE_DIR="${TARGET_DIRS[0]}"
          else
            echo "âŒ æœªæ‰¾åˆ°å›ºä»¶è¾“å‡ºç›®å½•"
            find bin -type d 2>/dev/null | head -20
            exit 1
          fi
        fi
        
        cd "$FIRMWARE_DIR"
        echo "å·²è¿›å…¥å›ºä»¶ç›®å½•: $(pwd)"
        ls -la || true
        
        # åˆ é™¤å†—ä½™packagesç›®å½•
        [ -d "packages" ] && rm -rf packages && echo "âœ… å·²åˆ é™¤packagesç›®å½•"
        
        # ç»Ÿè®¡å›ºä»¶æ–‡ä»¶æ•°é‡
        FIRMWARE_COUNT=$(ls *.bin *.img *.gz 2>/dev/null | wc -l)
        if [ $FIRMWARE_COUNT -eq 0 ]; then
          echo "âŒ å›ºä»¶ç›®å½•ä¸­æ— æœ‰æ•ˆå›ºä»¶æ–‡ä»¶"
          exit 1
        fi
        
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "FIRMWARE_FILES=$FIRMWARE_COUNT" >> $GITHUB_ENV
        echo "status=success" >> ${GITHUB_OUTPUT}

    - name: ä¸Šä¼ å›ºä»¶ç›®å½•
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}
        retention-days: 30  # å›ºä»¶ä¿ç•™30å¤©

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾å’Œè¯´æ˜
      id: tag
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        # ç”Ÿæˆå¸¦è®¾å¤‡æ ‡è¯†çš„æ ‡ç­¾
        RELEASE_TAG="istoreos-24.10.2-${{ env.ARCHITECTURE }}-xiguapi-v3-$(date +"%Y%m%d-%H%M")"
        echo "release_tag=$RELEASE_TAG" >> ${GITHUB_OUTPUT}
        
        # ç”Ÿæˆå‘å¸ƒè¯´æ˜
        cat > release.txt << EOF
        ## ğŸ“± è®¾å¤‡ä¿¡æ¯
        - æ¶æ„ï¼š${{ env.ARCHITECTURE }} (rk3568)
        - è®¾å¤‡ï¼šXiguapi V3
        - æºç ï¼š[${{ env.REPO_BRANCH }}](${{ env.REPO_URL }})
        
        ## âš™ï¸ å›ºä»¶é…ç½®
        - ç¼–è¯‘æ—¶é—´ï¼š$(date +"%Yå¹´%mæœˆ%dæ—¥%Hæ—¶%Måˆ†")
        - ç®¡ç†åœ°å€ï¼š192.168.100.1
        - ç™»å½•è´¦å·ï¼šroot
        - ç™»å½•å¯†ç ï¼špassword
        - ç½‘ç»œæ¨¡å¼ï¼šä¸»è·¯ç”±æ¨¡å¼ï¼ˆeth0=LANï¼Œeth1=WANï¼‰
        - ç¼–è¯‘ä¼˜åŒ–ï¼šå¯ç”¨ CCACHE ç¼“å­˜ + LLVM/Clang ç¼–è¯‘é“¾
        
        ## ğŸ“‹ ç¼–è¯‘è¯´æ˜
        1. åŸºäºiStore OS 24.10.2ç¨³å®šåˆ†æ”¯æ„å»º
        2. å·²æ’é™¤luci-app-baidupcs-webåŠä¾èµ–ï¼Œè§£å†³ç¼–è¯‘æŠ¥é”™
        3. é€‚é…Xiguapi V3ç¡¬ä»¶ï¼Œä¼˜åŒ–é©±åŠ¨å…¼å®¹æ€§
        4. ä¿ç•™iStore OSåŸç”ŸåŠŸèƒ½ï¼Œæ”¯æŒè½¯ä»¶ä¸­å¿ƒ
        5. æ‰§è¡Œä¸¤éfeeds update/installç¡®ä¿ä¾èµ–æ‹‰å–å®Œæ•´
        6. å¯ç”¨CCACHEåŠ é€Ÿç¼–è¯‘ï¼ŒLLVM/Clangæå‡ç¼–è¯‘æ•ˆç‡
        
        ## âš ï¸ åˆ·æœºæç¤º
        - è¯·ä½¿ç”¨TFå¡æˆ–USBåˆ·æœºï¼Œç¡®ä¿ç”µæºç¨³å®š
        - é¦–æ¬¡åˆ·æœºå»ºè®®æ¢å¤å‡ºå‚è®¾ç½®ï¼Œé¿å…é…ç½®å†²çª
        - å¦‚æœ‰é—®é¢˜è¯·åœ¨Issuesä¸­åé¦ˆ
        EOF
        
        echo "status=success" >> ${GITHUB_OUTPUT}

    - name: è‡ªåŠ¨å‘å¸ƒå›ºä»¶åˆ° Releases
      uses: softprops/action-gh-release@v2
      if: steps.tag.outputs.status == 'success' && !cancelled()
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*
        draft: false
        prerelease: false

    - name: æ¸…ç†æ—§å·¥ä½œæµè®°å½•
      uses: xiaomeng9597/delete-workflow-runs@main
      with:
        retain_days: 20
        keep_minimum_runs: 15
        token: ${{ env.GITHUB_TOKEN }}

    - name: æ¸…ç†æ—§ Releases
      uses: dev-drprasad/delete-older-releases@v0.3.3
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 60
        delete_tags: true
        repo: ${{ github.repository }}
        token: ${{ env.GITHUB_TOKEN }}
