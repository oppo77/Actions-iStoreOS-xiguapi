name: Build iStore OS 6.x

on:
  repository_dispatch:
  workflow_dispatch:
  schedule:
   - cron: 0 16 * * *

env:
  REPO_URL: https://github.com/istoreos/istoreos
  REPO_BRANCH: istoreos-24.10.2
  FEEDS_CONF: feeds.conf
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1-6.x.sh
  DIY_P2_SH: diy-part2-6.x.sh
  UPLOAD_BIN_DIR: true
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  ARCHITECTURE: armv8

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: æœ€å¤§åŒ–ç£ç›˜ç©ºé—´ï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼‰
      uses: easimon/maximize-build-space@master
      with:
        swap-size-mb: 2048
        temp-reserve-mb: 50
        root-reserve-mb: 2048
        remove-dotnet: true
        remove-android: true
        remove-haskell: true
        remove-codeql: true

    - name: å‡†å¤‡å®Œæˆ
      uses: actions/checkout@main

    - name: åˆ›å»ºå·¥ä½œç›®å½•
      run: |
        mkdir -p ${GITHUB_WORKSPACE}/workdir
        chmod 755 ${GITHUB_WORKSPACE}/workdir
        echo "WORKDIR=${GITHUB_WORKSPACE}/workdir" >> $GITHUB_ENV
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"

    - name: æ£€æŸ¥æœåŠ¡å™¨é…ç½®
      run: |
        echo "è‹¥åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½ä¸è¶³ï¼ŒåŠ¡å¿…åŠæ—¶å–æ¶ˆï¼Œé‡æ–°è¿è¡Œï¼"
        echo -e "------------------------------- CPUä¿¡æ¯ -------------------------------\n"
        echo "CPUç‰©ç†æ•°é‡:$(cat /proc/cpuinfo| grep "physical id"| sort| uniq| wc -l)"
        echo -e "CPUæ ¸å¿ƒåŠç‰ˆæœ¬ä¿¡æ¯: $(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c) \n"
        echo -e "------------------------------- å†…å­˜ä¿¡æ¯ -------------------------------\n"
        echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯: "
        sudo lshw -short -C memory | grep GiB
        echo -e "\n"
        echo -e "------------------------------- ç£ç›˜ä¿¡æ¯ï¼ˆæ¸…ç†å‰ï¼‰ -------------------------------\n"
        df -Th

    - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼šå…ˆæ¸…ç†å†è£…ä¾èµ–ï¼‰
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        echo "------------------------------- ä»…æ›´æ–°æºï¼ˆè·³è¿‡upgradeï¼Œé¿å…å ç”¨ç©ºé—´ï¼‰ -------------------------------"
        sudo apt update -y

        echo "------------------------------- å®‰è£…ç¼–è¯‘æ ¸å¿ƒä¾èµ–ï¼ˆæœ€å°åŒ–ï¼‰ -------------------------------"
        sudo apt install -y \
          build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          autoconf automake binutils libtool patch pkgconf quilt \
          gettext libncursesw5-dev libncurses-dev libreadline-dev \
          libssl-dev libelf-dev libglib2.0-dev device-tree-compiler \
          liblzma-dev libc6-dev-i386 lib32gcc-s1 lib32stdc++6 zlib1g-dev \
          python3 python3-pyelftools python3-setuptools python3-distutils \
          python3-pip python3-yaml python3-dev libpython3-dev \
          bzip2 ccache cpio curl rsync squashfs-tools unzip xxd bc haveged \
          uuid-runtime dosfstools mtools parted u-boot-tools \
          git xsltproc libxml-parser-perl ant wget cmake ninja-build patchelf swig \
          openjdk-11-jre-headless
        
        echo "------------------------------- Pythonå·¥å…·å®‰è£… -------------------------------"
        sudo pip3 install pyelftools setuptools pyyaml --no-cache-dir
        
        echo "------------------------------- æœ€ç»ˆç£ç›˜æ£€æŸ¥ -------------------------------"
        df -Th
        
        echo "------------------------------- è®¾ç½®æ—¶åŒº -------------------------------"
        sudo timedatectl set-timezone "$TZ"

    - name: å…‹éš†æºç 
      working-directory: ${{ env.WORKDIR }}
      run: |
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        df -hT $PWD
        git clone ${{ env.REPO_URL }} -b ${{ env.REPO_BRANCH }} openwrt
        echo "æºç å…‹éš†å®Œæˆï¼Œå½“å‰ç›®å½•å†…å®¹:"
        ls -la
        ln -sf ${{ env.WORKDIR }}/openwrt $GITHUB_WORKSPACE/openwrt || true

    # ç®€åŒ–åçš„è„šæœ¬æ‰§è¡Œæ­¥éª¤ï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼‰
    - name: æ‰§è¡Œxiguapi-v3è®¾å¤‡é€‚é…è„šæœ¬
      run: |
        echo "å·¥ä½œç›®å½•: ${{ env.WORKDIR }}"
        SCRIPT_PATH="${GITHUB_WORKSPACE}/xiguapi/xiguapi-v3-adapt.sh"
        if [ -f "$SCRIPT_PATH" ]; then
          echo "æ‰¾åˆ°é€‚é…è„šæœ¬: $SCRIPT_PATH"
          chmod +x $SCRIPT_PATH
          # æ˜¾å¼æŒ‡å®š OPENWRT_ROOT ä¸ºæºç ç›®å½•
          export OPENWRT_ROOT="${{ env.WORKDIR }}/openwrt"
          echo "OPENWRT_ROOTè®¾ç½®ä¸º: $OPENWRT_ROOT"
          # ç›´æ¥æ‰§è¡Œä»“åº“ä¸­çš„è„šæœ¬ï¼Œæ— éœ€å¤åˆ¶
          $SCRIPT_PATH
          if [ $? -eq 0 ]; then
            echo "âœ… xiguapi-v3é€‚é…è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
          else
            echo "âŒ xiguapi-v3é€‚é…è„šæœ¬æ‰§è¡Œå¤±è´¥"
            exit 1
          fi
        else
          echo "âŒ é€‚é…è„šæœ¬ä¸å­˜åœ¨: $SCRIPT_PATH"
          find ${GITHUB_WORKSPACE} -name "*.sh" -type f | head -20
          exit 1
        fi

    - name: åŠ è½½è‡ªå®šä¹‰ feeds
      env:
        FEEDS_CONF_PATH: ${{ env.ARCHITECTURE }}/${{ env.FEEDS_CONF }}
      working-directory: ${{ env.WORKDIR }}/openwrt
      run: |
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        [ -e $FEEDS_CONF_PATH ] && mv $FEEDS_CONF_PATH ${{ env.FEEDS_CONF }}
        chmod +x ${{ github.workspace }}/${{ env.DIY_P1_SH }}
        ${{ github.workspace }}/${{ env.DIY_P1_SH }}

    - name: æ›´æ–° feedsï¼ˆç¬¬1éï¼‰
      working-directory: ${{ env.WORKDIR }}/openwrt
      run: ./scripts/feeds update -a

    - name: æ›´æ–° feedsï¼ˆç¬¬2éï¼‰
      working-directory: ${{ env.WORKDIR }}/openwrt
      run: ./scripts/feeds update -a

    - name: å®‰è£… feedsï¼ˆç¬¬1éï¼‰
      working-directory: ${{ env.WORKDIR }}/openwrt
      run: ./scripts/feeds install -a

    - name: å®‰è£… feedsï¼ˆç¬¬2éï¼‰
      working-directory: ${{ env.WORKDIR }}/openwrt
      run: ./scripts/feeds install -a

    - name: åŠ è½½è‡ªå®šä¹‰é…ç½®
      env:
        CONFIG_FILE_PATH: ${{ github.workspace }}/${{ env.ARCHITECTURE }}/${{ env.CONFIG_FILE }}
      working-directory: ${{ env.WORKDIR }}/openwrt
      run: |
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        [ -d "files" ] && mv files ${{ github.workspace }}/files && echo "âœ… å¤‡ä»½ files ç›®å½•å®Œæˆ"
        
        if [ -e "$CONFIG_FILE_PATH" ]; then
          cp "$CONFIG_FILE_PATH" "${{ env.CONFIG_FILE }}"
          echo "âœ… åŠ è½½è‡ªå®šä¹‰é…ç½®æ–‡ä»¶: $CONFIG_FILE_PATH"
        else
          echo "âŒ è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_FILE_PATH"
          echo "å½“å‰ä»“åº“æ ¹ç›®å½•ä¸‹çš„ armv8 ç›®å½•å†…å®¹: $(ls -la ${{ github.workspace }}/${{ env.ARCHITECTURE }}/ 2>/dev/null || true)"
          exit 1
        fi
        
        chmod +x ${{ github.workspace }}/${{ env.DIY_P2_SH }}
        ${{ github.workspace }}/${{ env.DIY_P2_SH }}
        echo "âœ… æ‰§è¡Œ diy-part2.sh å®Œæˆ"
        
        sed -i '/luci-app-baidupcs-web/d' .config
        echo "âœ… ç§»é™¤ luci-app-baidupcs-web é…ç½®å®Œæˆ"
        
        echo "===== éªŒè¯ç¼–è¯‘ç›®æ ‡é…ç½® ====="
        if ! grep -q "CONFIG_TARGET_rockchip_armv8=y" .config; then
          echo "âŒ é”™è¯¯ï¼š.config ä¸­æœªé€‰ä¸­ rockchip/armv8 ç›®æ ‡"
          echo "å½“å‰ .config ä¸­çš„ç›®æ ‡é…ç½®:"
          grep -E "CONFIG_TARGET_(rockchip|ath79|ramips)" .config || true
          exit 1
        fi
        
        if ! grep -q "CONFIG_TARGET_rockchip_armv8_DEVICE_nlnet_xiguapi-v3=y" .config; then
          echo "âŒ é”™è¯¯ï¼š.config ä¸­æœªé€‰ä¸­ nlnet_xiguapi-v3 è®¾å¤‡"
          echo "å½“å‰å·²é€‰ä¸­çš„ rockchip è®¾å¤‡:"
          grep -E "CONFIG_TARGET_rockchip_armv8_DEVICE_" .config || true
          exit 1
        fi
        
        if grep -q "CONFIG_TARGET_ath79=y" .config; then
          echo "âŒ é”™è¯¯ï¼š.config ä¸­ä»é€‰ä¸­äº† ath79 ç›®æ ‡ï¼Œéœ€ç¦ç”¨"
          sed -i '/CONFIG_TARGET_ath79=y/d' .config
          sed -i 's/CONFIG_TARGET_ath79=.*/# CONFIG_TARGET_ath79 is not set/' .config
          echo "âœ… å·²ç¦ç”¨ ath79 ç›®æ ‡"
        fi
        
        echo "===== ç¼–è¯‘ç›®æ ‡é…ç½®éªŒè¯é€šè¿‡ ====="

    - name: ä¸‹è½½è½¯ä»¶åŒ…ï¼ˆç¬¬1éï¼‰
      id: package1
      working-directory: ${{ env.WORKDIR }}/openwrt
      run: |
        make defconfig
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: ä¸‹è½½è½¯ä»¶åŒ…ï¼ˆç¬¬2éï¼‰
      id: package2
      working-directory: ${{ env.WORKDIR }}/openwrt
      run: |
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: ç¼–è¯‘å›ºä»¶
      id: compile
      working-directory: ${{ env.WORKDIR }}/openwrt
      run: |
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        echo -e "$(nproc) thread compile"
        make -j$(nproc) || make -j1 || make -j1 V=s
        
        echo "ç¼–è¯‘å®Œæˆï¼Œæ£€æŸ¥å›ºä»¶ç›®å½•:"
        find bin -type f -name "*.bin" -o -name "*.img" -o -name "*.gz" 2>/dev/null | head -20 || true
        echo "binç›®å½•ç»“æ„:"
        ls -la bin/ || true
        if [ -d "bin/targets" ]; then
          echo "targetsç›®å½•ç»“æ„:"
          find bin/targets -type d 2>/dev/null | head -20 || true
        fi
        
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
        echo "status=success" >> ${GITHUB_OUTPUT}

    - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
      if: (!cancelled())
      run: df -hT

    - name: ä¸Šä¼  bin æ–‡ä»¶å¤¹
      uses: actions/upload-artifact@main
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      with:
        name: OpenWrt_bin${{ env.FILE_DATE }}
        path: ${{ env.WORKDIR }}/openwrt/bin

    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      working-directory: ${{ env.WORKDIR }}/openwrt
      run: |
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        
        if [ -d "bin/targets/rockchip/armv8" ]; then
          echo "æ‰¾åˆ°å›ºå®šè·¯å¾„: bin/targets/rockchip/armv8"
          FIRMWARE_DIR="bin/targets/rockchip/armv8"
        else
          TARGET_DIRS=($(find bin/targets -maxdepth 2 -mindepth 2 -type d ! -name "packages" 2>/dev/null))
          if [ ${#TARGET_DIRS[@]} -gt 0 ]; then
            echo "æ‰¾åˆ°é€šé…ç¬¦è·¯å¾„: ${TARGET_DIRS[0]}"
            FIRMWARE_DIR="${TARGET_DIRS[0]}"
          else
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°å›ºä»¶è¾“å‡ºç›®å½•"
            echo "å½“å‰ç›®å½•ç»“æ„:"
            ls -la
            echo "binç›®å½•ç»“æ„:"
            find bin -type d 2>/dev/null | head -20
            exit 1
          fi
        fi
        
        cd "$FIRMWARE_DIR"
        echo "å·²è¿›å…¥å›ºä»¶ç›®å½•: $(pwd)"
        echo "ç›®å½•å†…å®¹:"
        ls -la || true
        
        if [ -d "packages" ]; then
          rm -rf packages
          echo "å·²åˆ é™¤packagesç›®å½•"
        fi
        
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "FIRMWARE_FILES=$(ls *.bin *.img *.gz 2>/dev/null | wc -l)" >> $GITHUB_ENV
        echo "status=success" >> ${GITHUB_OUTPUT}

    - name: ä¸Šä¼ å›ºä»¶ç›®å½•
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "release_tag=$(date +"%Y.%m.%d-%H.%M")-${{ env.ARCHITECTURE }}-xiguapi-v3" >> ${GITHUB_OUTPUT}
        touch release.txt
        echo "
        ğŸ’» æ¶æ„: ${{ env.ARCHITECTURE }}
        ğŸ“‡ è®¾å¤‡: Xiguapi V3 (rk3568)
        ğŸ“‚ æºç : ${{ env.REPO_URL }}
        ğŸŒ³ åˆ†æ”¯: ${{ env.REPO_BRANCH }}
        â±ï¸ ç¼–è¯‘æ—¶é—´: $(date +"%Yå¹´%mæœˆ%dæ—¥%Hæ—¶%Måˆ†")
        ğŸŒ ç®¡ç†åœ°å€: 192.168.100.1
        ğŸ‘¤ ç”¨æˆ·å: root
        ğŸ”’ å¯†ç : password
        ğŸ“’ è¯´æ˜: Xiguapi V3 è®¾å¤‡ä¸“å±å›ºä»¶ï¼Œé»˜è®¤ç½‘å£ eth0=LAN, eth1=WANï¼Œä¸»è·¯ç”±æ¨¡å¼ã€‚ " >> release.txt
        echo "status=success" >> ${GITHUB_OUTPUT}

    - name: è‡ªåŠ¨å‘å¸ƒå›ºä»¶åˆ° Releases
      uses: softprops/action-gh-release@v2
      if: steps.tag.outputs.status == 'success' && !cancelled()
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*

    - name: åˆ é™¤è¿è¡Œè®°å½•
      uses: xiaomeng9597/delete-workflow-runs@main
      with:
        retain_days: 20
        keep_minimum_runs: 15
        token: ${{ env.GITHUB_TOKEN }}

    - name: åˆ é™¤è‡ªåŠ¨å‘å¸ƒçš„æ—§å›ºä»¶
      uses: dev-drprasad/delete-older-releases@v0.3.3
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 60
        delete_tags: true
