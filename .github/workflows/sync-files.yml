name: Sync Files

on:
  repository_dispatch:
  workflow_dispatch:
  schedule:
    - cron: 55 15 * * *

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
    - name: 准备完成
      uses: actions/checkout@main

    - name: 下载架构编译配置文件
      run: |
        mkdir -p ./armv8
        wget -O ./armv8/feeds.conf https://fw0.koolcenter.com/iStoreOS/t68m/feeds.conf --no-check-certificate
        wget -O ./armv8/.config https://fw0.koolcenter.com/iStoreOS/t68m/config.buildinfo --no-check-certificate

        FILE_PATH="./armv8/.config"
        if [ -f "$FILE_PATH" ] && [ -s "$FILE_PATH" ]; then
           # 读取并清理自定义配置（去首尾空格）
           content=$(cat ${GITHUB_WORKSPACE}/configfiles/config_data-6.x.txt)
           configdata=$(echo "$content" | sed 's/^[[:space:]]*//; s/[[:space:]]*$//')
           # 追加自定义配置到.config末尾
           echo -e "\\n$configdata" >> ./armv8/.config

           # ========== 原有：配置优化修改 ==========
           # 1. 关闭 CONFIG_ALL_KMODS=y，改为禁用
           sed -i 's/^CONFIG_ALL_KMODS=y$/# CONFIG_ALL_KMODS is not set/' ./armv8/.config
           # 2. 修改根分区大小为 2048MB
           sed -i 's/^CONFIG_TARGET_ROOTFS_PARTSIZE=256$/CONFIG_TARGET_ROOTFS_PARTSIZE=2048/' ./armv8/.config
           # 3. 将 libevent2 相关模块从可安装包(m)改为内置(y)
           sed -i 's/^CONFIG_PACKAGE_libevent2-core=m$/CONFIG_PACKAGE_libevent2-core=y/' ./armv8/.config
           sed -i 's/^CONFIG_PACKAGE_libevent2-openssl=m$/CONFIG_PACKAGE_libevent2-openssl=y/' ./armv8/.config
           sed -i 's/^CONFIG_PACKAGE_libevent2-pthreads=m$/CONFIG_PACKAGE_libevent2-pthreads=y/' ./armv8/.config
           # 4. 禁用 wpad-basic-mbedtls 包
           sed -i 's/^CONFIG_PACKAGE_wpad-basic-mbedtls=m$/# CONFIG_PACKAGE_wpad-basic-mbedtls is not set/' ./armv8/.config
           # 5. 关闭调试信息配置，减少固件体积
           sed -i 's/^CONFIG_REPRODUCIBLE_DEBUG_INFO=y$/# CONFIG_REPRODUCIBLE_DEBUG_INFO is not set/' ./armv8/.config
           sed -i 's/^CONFIG_KERNEL_DEBUG_INFO_BTF=y$/# CONFIG_KERNEL_DEBUG_INFO_BTF is not set/' ./armv8/.config
           # =======================================

           # ========== 新增：强制关闭 LLVM 编译链 ==========
           # 【核心】无论从哪个源来的 LLVM 配置，都强制关闭，确保使用 GCC
           sed -i 's/^CONFIG_USE_LLVM_BUILD=y$/# CONFIG_USE_LLVM_BUILD is not set/' ./armv8/.config
           # 同时关闭内核相关的 LLVM 选项，确保彻底
           sed -i 's/^CONFIG_KERNEL_LLVM=y$/# CONFIG_KERNEL_LLVM is not set/' ./armv8/.config
           sed -i 's/^CONFIG_KERNEL_CLANG=y$/# CONFIG_KERNEL_CLANG is not set/' ./armv8/.config
           echo "✅ 已强制关闭所有 LLVM/Clang 相关编译选项。"
           # ================================================

           # ========== 原有：删除旧设备配置 ==========
           sed -i '/^CONFIG_TARGET_DEVICE_rockchip_armv8_DEVICE/d' ./armv8/.config
           sed -i '/^CONFIG_TARGET_MULTI_PROFILE=y$/d' ./armv8/.config
           # =====================================

           # 原有：清除重复配置项 + 过滤空行
           configdata2=$(cat ./armv8/.config)
           echo "$configdata2" | awk '!seen[$0]++ && NF > 0' > ./armv8/.config
        else
           echo "不处理数据。"
        fi

    - name: 同步配置
      uses: peaceiris/actions-gh-pages@v3
      with:
        personal_token: ${{ secrets.GITHUB_TOKEN }}
        publish_branch: main
        publish_dir: ./
        user_name: 'GitHub Action'
        user_email: 'github-actions[bot]@github.com'
        exclude_assets: ''
        keep_files: true
        commit_message: "Sync files: 优化配置（关闭全模块/扩容分区/调整libevent2/禁用wpad-basic-mbedtls/关闭调试/强制使用GCC）"

    - name: 删除运行记录
      uses: xiaomeng9597/delete-workflow-runs@main
      with:
        retain_days: 20
        keep_minimum_runs: 15
        token: ${{ secrets.GITHUB_TOKEN }}
