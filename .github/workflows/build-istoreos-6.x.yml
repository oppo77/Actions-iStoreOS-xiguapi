name: Build iStore OS 6.x (Xiguapi V3)

on:
  repository_dispatch:
  workflow_dispatch:
  schedule:
    - cron: 0 16 * * *

env:
  REPO_URL: https://github.com/istoreos/istoreos
  REPO_BRANCH: istoreos-24.10.2
  FEEDS_CONF: feeds.conf
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1-6.x.sh
  DIY_P2_SH: diy-part2-6.x.sh
  UPLOAD_BIN_DIR: true
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  ARCHITECTURE: armv8

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
    - name: 最大化磁盘空间
      uses: easimon/maximize-build-space@master
      with:
        swap-size-mb: 2048
        temp-reserve-mb: 50
        root-reserve-mb: 2048
        remove-dotnet: true
        remove-android: true
        remove-haskell: true
        remove-codeql: true

    - name: 准备完成
      uses: actions/checkout@main

    - name: 创建工作目录和缓存
      run: |
        mkdir -p ${GITHUB_WORKSPACE}/workdir
        mkdir -p ${GITHUB_WORKSPACE}/ccache
        chmod 755 ${GITHUB_WORKSPACE}/workdir ${GITHUB_WORKSPACE}/ccache
        echo "WORKDIR=${GITHUB_WORKSPACE}/workdir" >> $GITHUB_ENV
        echo "CCACHE_DIR=${GITHUB_WORKSPACE}/ccache" >> $GITHUB_ENV
        echo "OPENWRT_ROOT=${GITHUB_WORKSPACE}/workdir/openwrt" >> $GITHUB_ENV

    - name: 缓存CCACHE
      uses: actions/cache@v4
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ${{ runner.os }}-ccache-${{ env.ARCHITECTURE }}-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-ccache-${{ env.ARCHITECTURE }}-

    - name: 初始化编译环境 (GCC版本)
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        echo "更新软件包列表..."
        sudo apt update -y
        
        echo "安装编译核心依赖（GCC工具链）..."
        # 注意：已完全移除 clang, lld, llvm 等包
        sudo apt install -y \
          build-essential \
          flex bison g++ gawk gcc-multilib g++-multilib \
          autoconf automake binutils libtool patch pkgconf quilt \
          gettext libncursesw5-dev libncurses-dev libreadline-dev \
          libssl-dev libelf-dev libglib2.0-dev device-tree-compiler \
          liblzma-dev libc6-dev-i386 lib32gcc-s1 lib32stdc++6 zlib1g-dev \
          python3 python3-pyelftools python3-setuptools python3-distutils \
          python3-pip python3-yaml python3-dev libpython3-dev \
          bzip2 ccache cpio curl rsync squashfs-tools unzip xxd bc haveged \
          uuid-runtime dosfstools mtools parted u-boot-tools \
          git xsltproc libxml-parser-perl ant wget cmake ninja-build patchelf swig \
          openjdk-11-jre-headless
        
        echo "安装Python工具..."
        sudo pip3 install pyelftools setuptools pyyaml --no-cache-dir
        
        echo "配置CCACHE..."
        ccache --set-config=max_size=10G
        ccache --set-config=compression=true
        ccache --set-config=compression_level=6
        ccache -s
        
        echo "设置时区..."
        sudo timedatectl set-timezone "$TZ"
        
        echo "✅ GCC编译环境初始化完成"

    - name: 克隆源码
      working-directory: ${{ env.WORKDIR }}
      run: |
        echo "当前工作目录: $(pwd)"
        git clone --depth 1 ${{ env.REPO_URL }} -b ${{ env.REPO_BRANCH }} openwrt
        echo "源码克隆完成"
        ln -sf ${{ env.WORKDIR }}/openwrt $GITHUB_WORKSPACE/openwrt || true

    - name: 执行xiguapi-v3设备适配脚本（硬件适配）
      run: |
        echo "🔄 执行Xiguapi V3设备硬件适配..."
        SCRIPT_PATH="${GITHUB_WORKSPACE}/xiguapi/xiguapi-v3-adapt.sh"
        if [ -f "$SCRIPT_PATH" ]; then
          chmod +x "$SCRIPT_PATH"
          echo "OPENWRT_ROOT设置为: $OPENWRT_ROOT"
          cd "${GITHUB_WORKSPACE}"
          $SCRIPT_PATH
          if [ $? -eq 0 ]; then
            echo "✅ Xiguapi V3设备硬件适配成功"
          else
            echo "❌ Xiguapi V3设备硬件适配失败"
            exit 1
          fi
        else
          echo "❌ 适配脚本不存在: $SCRIPT_PATH"
          exit 1
        fi

    - name: 加载自定义 feeds
      env:
        FEEDS_CONF_PATH: ${{ github.workspace }}/${{ env.ARCHITECTURE }}/${{ env.FEEDS_CONF }}
      working-directory: ${{ env.OPENWRT_ROOT }}
      run: |
        echo "📦 加载自定义feeds..."
        if [ -e "$FEEDS_CONF_PATH" ]; then
          cp "$FEEDS_CONF_PATH" ${{ env.FEEDS_CONF }}
          echo "✅ 已加载自定义 feeds.conf"
        fi
        
        # 排除luci-app-baidupcs-web
        sed -i '/luci-app-baidupcs-web/d' ${{ env.FEEDS_CONF }}
        sed -i '/baidupcs-web/d' ${{ env.FEEDS_CONF }}
        echo "✅ 已排除luci-app-baidupcs-web相关包"

    - name: 更新 feeds（第1遍）
      working-directory: ${{ env.OPENWRT_ROOT }}
      run: ./scripts/feeds update -a

    - name: 更新 feeds（第2遍）
      working-directory: ${{ env.OPENWRT_ROOT }}
      run: ./scripts/feeds update -a

    - name: 安装 feeds（第1遍）- 排除 luci-app-baidupcs-web
      working-directory: ${{ env.OPENWRT_ROOT }}
      run: ./scripts/feeds install -a -x luci-app-baidupcs-web

    - name: 安装 feeds（第2遍）- 排除 luci-app-baidupcs-web
      working-directory: ${{ env.OPENWRT_ROOT }}
      run: |
        ./scripts/feeds install -a -x luci-app-baidupcs-web
        # 清理可能残留的baidupcs-web相关目录
        rm -rf package/feeds/*/luci-app-baidupcs-web 2>/dev/null || true
        rm -rf package/feeds/*/baidupcs-web 2>/dev/null || true
        rm -rf package/custom/luci-app-baidupcs-web 2>/dev/null || true
        rm -rf package/custom/baidupcs-web 2>/dev/null || true
        echo "✅ feeds安装完成"

    - name: 执行diy-part2-6.x.sh（添加额外包）
      working-directory: ${{ env.OPENWRT_ROOT }}
      run: |
        echo "🔄 执行diy-part2.sh添加额外包..."
        chmod +x ${{ github.workspace }}/${{ env.DIY_P2_SH }}
        ${{ github.workspace }}/${{ env.DIY_P2_SH }}
        echo "✅ diy-part2.sh执行完成"

    - name: 加载自定义配置
      env:
        CONFIG_FILE_PATH: ${{ github.workspace }}/${{ env.ARCHITECTURE }}/${{ env.CONFIG_FILE }}
      working-directory: ${{ env.OPENWRT_ROOT }}
      run: |
        echo "📄 加载自定义配置..."
        
        # 1. 检查配置文件
        if [ ! -f "$CONFIG_FILE_PATH" ]; then
          echo "❌ 配置文件不存在: $CONFIG_FILE_PATH"
          exit 1
        fi
        
        # 2. 复制配置文件
        cp "$CONFIG_FILE_PATH" "${{ env.CONFIG_FILE }}"
        echo "✅ 已复制自定义配置文件"
        
        # 3. 验证关键配置项
        echo "🔍 验证关键配置项..."
        
        REQUIRED_CONFIGS=(
          "CONFIG_TARGET_rockchip_armv8=y"
          "CONFIG_TARGET_rockchip_armv8_DEVICE_nlnet_xiguapi-v3=y"
        )
        
        missing_configs=()
        for config in "${REQUIRED_CONFIGS[@]}"; do
          clean_config=$(echo "$config" | sed 's/"//g')
          if grep -q "$clean_config" .config; then
            echo "  ✅ $config"
          else
            echo "  ❌ $config"
            missing_configs+=("$config")
          fi
        done
        
        if [ ${#missing_configs[@]} -gt 0 ]; then
          echo "❌ 配置文件缺失必需项"
          exit 1
        fi
        
        # 4. 执行make defconfig
        echo "⚙️ 运行 make defconfig..."
        make defconfig >/dev/null 2>&1
        
        
        # 6. 确保启用CCACHE
        if ! grep -q "CONFIG_CCACHE=y" .config; then
          echo "CONFIG_CCACHE=y" >> .config
        fi
        
        echo "✅ 配置加载完成"

    - name: 执行diy-part1-6.x.sh（版本信息修改）
      working-directory: ${{ env.OPENWRT_ROOT }}
      run: |
        echo "🔄 执行diy-part1.sh修改版本信息..."
        chmod +x ${{ github.workspace }}/${{ env.DIY_P1_SH }}
        ${{ github.workspace }}/${{ env.DIY_P1_SH }}
        echo "✅ diy-part1.sh执行完成"

    - name: 下载软件包
      working-directory: ${{ env.OPENWRT_ROOT }}
      run: |
        make defconfig
        make download -j8

    - name: 编译固件
      id: compile
      working-directory: ${{ env.OPENWRT_ROOT }}
      run: |
        echo "🔨 开始编译固件..."
        export CCACHE_DIR=${{ env.CCACHE_DIR }}
        export USE_CCACHE=1
        
        make -j$(nproc) || make -j1 V=s
        
        if [ -d "bin/targets" ]; then
          echo "✅ 编译成功"
          echo "status=success" >> ${GITHUB_OUTPUT}
        else
          echo "❌ 编译失败"
          exit 1
        fi
        
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    # ... 后续的上传和发布步骤保持不变 ...
