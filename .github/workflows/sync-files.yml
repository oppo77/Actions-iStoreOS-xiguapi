name: Sync Files

on:
  repository_dispatch:
  workflow_dispatch:
  schedule:
    - cron: 55 15 * * *

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
    - name: 准备完成
      uses: actions/checkout@main

    - name: 下载架构编译配置文件
      run: |
        mkdir -p ./armv8
        wget -O ./armv8/feeds.conf https://fw0.koolcenter.com/iStoreOS/t68m/feeds.conf --no-check-certificate
        wget -O ./armv8/.config https://fw0.koolcenter.com/iStoreOS/t68m/config.buildinfo --no-check-certificate

        FILE_PATH="./armv8/.config"
        if [ -f "$FILE_PATH" ] && [ -s "$FILE_PATH" ]; then
           # 读取并清理自定义配置（去首尾空格）
           content=$(cat ${GITHUB_WORKSPACE}/configfiles/config_data-6.x.txt)
           configdata=$(echo "$content" | sed 's/^[[:space:]]*//; s/[[:space:]]*$//')
           # 追加自定义配置到.config末尾
           echo -e "\\n$configdata" >> ./armv8/.config

           # ... [中间的所有 sed 修改操作保持不变] ...

           # 原有：清除重复配置项 + 过滤空行
           configdata2=$(cat ./armv8/.config)
           echo "$configdata2" | awk '!seen[$0]++ && NF > 0' > ./armv8/.config
        else
           echo "不处理数据。"
        fi

    - name: 同步配置
      uses: peaceiris/actions-gh-pages@v3
      with:
        personal_token: ${{ secrets.GITHUB_TOKEN }}
        publish_branch: main
        publish_dir: ./
        user_name: 'GitHub Action'
        user_email: 'github-actions[bot]@github.com'
        exclude_assets: ''
        keep_files: true
        commit_message: "Sync files: 优化配置（关闭全模块/扩容分区/调整libevent2/禁用wpad-basic-mbedtls/关闭调试/强制使用GCC）"

    # 将清理步骤移到这里，作为 sync job 的最后一个步骤
    - name: 清理旧工作流运行记录（自定义）
      if: always()
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "开始清理旧的工作流运行记录..."
        
        # 获取当前工作流的所有运行ID（排除正在运行的）
        runs=$(gh run list --workflow="${{ github.workflow }}" --json databaseId,status,createdAt --jq '.[] | select(.status != "in_progress" and .status != "queued") | "\(.databaseId) \(.createdAt)"' | sort -k2)
        
        # 计算要保留的数量（保留最新的10条）
        total_to_keep=10
        total_runs=$(echo "$runs" | wc -l)
        
        if [ $total_runs -le $total_to_keep ]; then
          echo "当前只有 ${total_runs} 条记录，未超过保留上限 ${total_to_keep}，跳过清理。"
          exit 0
        fi
        
        # 计算需要删除的数量
        runs_to_delete=$((total_runs - total_to_keep))
        echo "找到 ${total_runs} 条记录，计划删除最旧的 ${runs_to_delete} 条。"
        
        # 提取需要删除的ID（最旧的前runs_to_delete条）
        delete_ids=$(echo "$runs" | head -n $runs_to_delete | awk '{print $1}')
        
        # 循环删除
        for run_id in $delete_ids; do
          echo "正在删除运行记录 ID: $run_id"
          gh run delete "$run_id" --confirm || echo "删除 $run_id 失败（可能已被其他进程删除）"
        done
        
        echo "✅ 工作流运行记录清理完成。"
